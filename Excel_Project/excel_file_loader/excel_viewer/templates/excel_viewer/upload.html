{% extends 'excel_viewer/base.html' %}

{% block title %}Upload Files - Excel File Viewer{% endblock %}

{% block page_title %}Upload Excel Files{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">üì§ Upload Three Excel Files</h4>
            </div>
            <div class="card-body">
                <p class="card-text mb-4">
                    Please select three Excel files (.xlsx or .xls format) that you want to upload and view. 
                    Each file can be up to 50MB in size.
                </p>
                
                <!-- Upload Form -->
                <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
                    {% csrf_token %}
                    
                    <div class="upload-area">
                        <div class="row">
                            <!-- File 1 -->
                            <div class="col-md-4 mb-3">
                                <div class="card border-primary">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">üìã File 1</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label for="{{ form.file1.id_for_label }}" class="form-label">
                                                {{ form.file1.label }}
                                            </label>
                                            {{ form.file1 }}
                                            {% if form.file1.help_text %}
                                                <div class="form-text">{{ form.file1.help_text }}</div>
                                            {% endif %}
                                            {% if form.file1.errors %}
                                                <div class="text-danger">
                                                    {% for error in form.file1.errors %}
                                                        <small>{{ error }}</small><br>
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- File 2 -->
                            <div class="col-md-4 mb-3">
                                <div class="card border-success">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">üìã File 2</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label for="{{ form.file2.id_for_label }}" class="form-label">
                                                {{ form.file2.label }}
                                            </label>
                                            {{ form.file2 }}
                                            {% if form.file2.help_text %}
                                                <div class="form-text">{{ form.file2.help_text }}</div>
                                            {% endif %}
                                            {% if form.file2.errors %}
                                                <div class="text-danger">
                                                    {% for error in form.file2.errors %}
                                                        <small>{{ error }}</small><br>
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- File 3 -->
                            <div class="col-md-4 mb-3">
                                <div class="card border-info">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">üìã File 3</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label for="{{ form.file3.id_for_label }}" class="form-label">
                                                {{ form.file3.label }}
                                            </label>
                                            {{ form.file3 }}
                                            {% if form.file3.help_text %}
                                                <div class="form-text">{{ form.file3.help_text }}</div>
                                            {% endif %}
                                            {% if form.file3.errors %}
                                                <div class="text-danger">
                                                    {% for error in form.file3.errors %}
                                                        <small>{{ error }}</small><br>
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Form Actions -->
                    <div class="text-center mt-4">
                        <button type="submit" class="btn btn-primary btn-lg me-3">
                            üöÄ Upload and Process Files
                        </button>
                        <a href="{% url 'excel_viewer:home' %}" class="btn btn-secondary btn-lg">
                            üè† Back to Home
                        </a>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Help Section -->
        <div class="card shadow mt-4">
            <div class="card-header bg-light">
                <h5 class="mb-0">üí° Upload Guidelines</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>‚úÖ Supported Formats:</h6>
                        <ul>
                            <li>.xlsx (Excel 2007+)</li>
                            <li>.xls (Excel 97-2003)</li>
                        </ul>
                        
                        <h6 class="mt-3">üìè File Requirements:</h6>
                        <ul>
                            <li>Maximum size: 50MB per file</li>
                            <li>Files must not be empty</li>
                            <li>All three files are required</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>üîí Security Notes:</h6>
                        <ul>
                            <li>Files are processed in memory</li>
                            <li>No permanent file storage</li>
                            <li>Data is cleared when session ends</li>
                        </ul>
                        
                        <h6 class="mt-3">üìä What Happens Next:</h6>
                        <ul>
                            <li>Files are validated and processed</li>
                            <li>Data is converted to HTML tables</li>
                            <li>You'll be redirected to view results</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Clear Session Option -->
        {% if request.session.excel_data %}
            <div class="card shadow mt-4 border-warning">
                <div class="card-body text-center">
                    <h6 class="card-title">‚ö†Ô∏è Previous Data Found</h6>
                    <p class="card-text">
                        You have previously uploaded files. You can view them or clear the session to start fresh.
                    </p>
                    <a href="{% url 'excel_viewer:show_data' %}" class="btn btn-success btn-custom">
                        üìä View Previous Data
                    </a>
                    <a href="{% url 'excel_viewer:clear_session' %}" class="btn btn-warning btn-custom">
                        üóëÔ∏è Clear Session & Start Fresh
                    </a>
                </div>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block javascript %}
<script>
// File upload validation and preview
document.addEventListener('DOMContentLoaded', function() {
    const fileInputs = document.querySelectorAll('input[type="file"]');
    
    fileInputs.forEach(function(input) {
        input.addEventListener('change', function(e) {
            const file = e.target.files[0];
            const cardBody = e.target.closest('.card-body');
            
            // Remove any existing file info
            const existingInfo = cardBody.querySelector('.file-preview');
            if (existingInfo) {
                existingInfo.remove();
            }
            
            if (file) {
                // Create file info display
                const fileInfo = document.createElement('div');
                fileInfo.className = 'file-preview mt-2 p-2 bg-light rounded';
                fileInfo.innerHTML = `
                    <small>
                        <strong>üìÑ ${file.name}</strong><br>
                        üìè Size: ${(file.size / 1024 / 1024).toFixed(2)} MB<br>
                        üìÖ Modified: ${new Date(file.lastModified).toLocaleDateString()}
                    </small>
                `;
                cardBody.appendChild(fileInfo);
                
                // Validate file extension
                const validExtensions = ['.xlsx', '.xls'];
                const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
                
                if (!validExtensions.includes(fileExtension)) {
                    fileInfo.classList.add('border', 'border-danger');
                    fileInfo.innerHTML += '<br><small class="text-danger">‚ö†Ô∏è Invalid file type</small>';
                } else if (file.size > 50 * 1024 * 1024) {
                    fileInfo.classList.add('border', 'border-danger');
                    fileInfo.innerHTML += '<br><small class="text-danger">‚ö†Ô∏è File too large</small>';
                } else {
                    fileInfo.classList.add('border', 'border-success');
                    fileInfo.innerHTML += '<br><small class="text-success">‚úÖ File looks good</small>';
                }
            }
        });
    });
});
</script>
{% endblock %}